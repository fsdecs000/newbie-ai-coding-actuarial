<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actuarial Project Starter</title>
    <!-- Use Tailwind CSS for simple, mobile-friendly styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-50;
        }
        .container {
            max-width: 600px;
        }
        .card {
            @apply bg-white rounded-2xl shadow-xl p-8;
        }
        .glow-button {
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }
        .glow-button:hover {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <div class="container w-full mx-auto text-center">
        <div class="card">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4">
                Actuarial App Starter ðŸ“ˆ
            </h1>
            <p class="text-gray-500 mb-6">
                A simple app to calculate a present value and simulate a data pipeline.
            </p>

            <!-- Input fields for actuarial calculation -->
            <div class="space-y-4 mb-6 text-left">
                <div>
                    <label for="futureValue" class="block text-sm font-medium text-gray-700">Future Value (FV)</label>
                    <input type="number" id="futureValue" value="1000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="interestRate" class="block text-sm font-medium text-gray-700">Interest Rate (as a decimal)</label>
                    <input type="number" step="0.001" id="interestRate" value="0.05" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="periods" class="block text-sm font-medium text-gray-700">Number of Periods (n)</label>
                    <input type="number" id="periods" value="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="space-y-4">
                <button id="calculateBtn" class="glow-button w-full py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                    Calculate Present Value
                </button>
                <button id="runPipelineBtn" class="glow-button w-full py-3 px-6 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200">
                    Run Data Pipeline
                </button>
            </div>

            <!-- Results and Status Display -->
            <div id="results" class="mt-8 text-left bg-gray-100 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Results & Status</h2>
                <div id="statusMessage" class="font-medium text-blue-600">Loading...</div>
                <div id="pvResult" class="mt-4 hidden">
                    <span class="text-lg font-bold text-gray-700">Present Value (PV):</span>
                    <span id="pvValue" class="text-lg font-semibold text-green-700 ml-2"></span>
                </div>
                <div id="pipelineResult" class="mt-4 hidden">
                    <span class="text-lg font-bold text-gray-700">Pipeline Output:</span>
                    <pre id="pipelineValue" class="mt-2 p-2 bg-gray-200 rounded-md text-sm overflow-x-auto"></pre>
                </div>
            </div>

            <!-- User ID Display -->
            <p class="text-gray-400 text-sm mt-8 break-words">
                Your unique user ID is: <br/><span id="userIdDisplay" class="font-mono text-xs">Waiting for connection...</span>
            </p>
        </div>
    </div>

    <!-- Firebase and main JavaScript logic -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        let db;
        let auth;
        let userId;
        const statusMessageEl = document.getElementById('statusMessage');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const pvResultEl = document.getElementById('pvResult');
        const pvValueEl = document.getElementById('pvValue');
        const pipelineResultEl = document.getElementById('pipelineResult');
        const pipelineValueEl = document.getElementById('pipelineValue');

        // --- FIREBASE & AUTH SETUP (SIMULATING A BACKEND) ---
        window.onload = async function() {
            try {
                // Get global Firebase variables provided by the environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (Object.keys(firebaseConfig).length === 0) {
                  throw new Error("Firebase config not available.");
                }

                // Initialize Firebase app and services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                const currentUser = auth.currentUser;
                if (currentUser) {
                    userId = currentUser.uid;
                    userIdDisplayEl.textContent = userId;
                    updateStatus("Connected successfully.");
                    // Check if a document exists for this user, if not, create one
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/appData/example`);
                    onSnapshot(userDocRef, (docSnap) => {
                      if (!docSnap.exists()) {
                          setDoc(userDocRef, { initialized: true });
                      }
                    });
                } else {
                    throw new Error("User authentication failed.");
                }

            } catch (e) {
                console.error("Firebase setup failed: ", e);
                updateStatus("Failed to set up the app. See console.");
            }
        };

        // --- CORE APPLICATION LOGIC (SIMULATING PYTHON/SQL) ---

        // This function simulates a simple actuarial calculation,
        // which might be done on a Python backend in a real application.
        function calculatePresentValue(fv, r, n) {
            // Formula for Present Value (PV)
            // PV = FV / (1 + r)^n
            if (r <= -1) {
                updateStatus("Interest rate must be greater than -1.");
                return null;
            }
            return fv / Math.pow(1 + r, n);
        }

        // This function simulates a simple data pipeline.
        // In a real project, this might be a complex Python script
        // that connects to a SQL database and transforms data.
        function runDataPipeline() {
            updateStatus("Running data pipeline...");
            const rawData = [
                { id: 1, value: 100, status: "raw" },
                { id: 2, value: 250, status: "raw" },
                { id: 3, value: 320, status: "raw" }
            ];
            
            // Step 1: Filter out values below 200
            const filteredData = rawData.filter(item => item.value >= 200);

            // Step 2: Add a new "processed" field
            const processedData = filteredData.map(item => ({
                ...item,
                processedValue: item.value * 1.25,
                status: "processed"
            }));

            // Step 3: Save the processed data to the database
            const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/dataPipelines/processedData`);
            setDoc(docRef, {
                timestamp: new Date().toISOString(),
                output: JSON.stringify(processedData)
            }).then(() => {
                updateStatus("Data pipeline completed and saved!");
                pipelineResultEl.style.display = 'block';
                pipelineValueEl.textContent = JSON.stringify(processedData, null, 2);
            }).catch(e => {
                updateStatus("Error saving pipeline data.");
                console.error("Error saving pipeline data: ", e);
            });
        }

        // --- CYBERSECURITY (SIMULATED SHIELD) ---
        // This function simulates a basic security check.
        // In a real app, this would be handled on the server.
        function securityCheck() {
            // A simple check to ensure a user ID exists
            // and the user is authenticated.
            if (!userId) {
                updateStatus("Security alert: User is not authenticated.");
                return false;
            }
            updateStatus("Security check passed.");
            return true;
        }

        // --- EVENT LISTENERS ---
        document.getElementById('calculateBtn').addEventListener('click', () => {
            if (!securityCheck()) return;
            pvResultEl.style.display = 'none';

            const fv = parseFloat(document.getElementById('futureValue').value);
            const r = parseFloat(document.getElementById('interestRate').value);
            const n = parseFloat(document.getElementById('periods').value);

            if (isNaN(fv) || isNaN(r) || isNaN(n)) {
                updateStatus("Please enter valid numbers.");
                return;
            }

            const pv = calculatePresentValue(fv, r, n);
            if (pv !== null) {
                pvResultEl.style.display = 'block';
                pvValueEl.textContent = `$${pv.toFixed(2)}`;
                updateStatus("Calculation successful!");
            }
        });

        document.getElementById('runPipelineBtn').addEventListener('click', () => {
            if (!securityCheck()) return;
            pipelineResultEl.style.display = 'none';
            runDataPipeline();
        });

        // Helper function to update the status message
        function updateStatus(message) {
            statusMessageEl.textContent = message;
        }

    </script>
</body>
</html>
